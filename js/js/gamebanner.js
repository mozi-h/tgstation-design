function getCookie(e){for(var r=e+"=",n=document.cookie.split(";"),a=0;a<n.length;a++){var t=n[a].trim();if(0==t.indexOf(r))return t.substring(r.length,t.length)}return""}var refreshjobs={};function setupreloader(e,r){var n;refreshjobs[e]?console.log("Dupe reload job"+e):($(r).removeAttr("src"),(n=$('<span class="gamebanner statuserror"></span>')).append('<span class="gamebannerline gamebanneraddrline"><span class="gamebanneraddr"></span><span class="gamebannericons"><span class="gamebannericon gamebannerbunker"> <i title="This server is not accepting connections from new players (Panic Bunker)" class="bi bi-shield"></i></span><span class="gamebannericon gamebannernoenter"><i title="Spectate only, Entry into the round has been disabled." class="bi bi-eyeglasses"></i></span><span class="gamebannericon gamebannerhub"><i title="This server is on the BYOND hub" class="bi bi-globe"></i></span></span></span>','<span class="gamebannerline gamebannername"></span>','<span class="gamebannerline gamebannermode"></span>','<span class="gamebannerline gamebannermap"></span>','<span class="gamebannerline gamebannerttl"></span>','<span class="gamebannerline gamebannererror"></span>'),refreshjobs[e]={server:e,target:r,gamebannerspan:n,spinning:!0})}function displayrefreshstatus(){getCookie("disablerefresh")?document.getElementById("refreshstatus").innerHTML='<span style="color:red;font-weight:bold;">Disabled</span>':document.getElementById("refreshstatus").innerHTML='<span style="color:green;font-weight:bold;">Enabled</span>'}function kick_reload_jobs(){for(var e in refreshjobs){e=refreshjobs[e];e&&e.timer&&reloadimg(e)}}function refreshtoggleclick(){if(getCookie("disablerefresh"))return document.cookie="disablerefresh=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",reloadbanners(),void displayrefreshstatus();document.cookie="disablerefresh=1; expires=Thu, 2038-01-19 04:14:00 GMT; path=/",displayrefreshstatus()}function round_to_precision(e,r){e=+e+(void 0===r?.5:r/2);return e-e%(void 0===r?1:+r)}function pad(e,r,n){return n=n||"0",(e+="").length>=r?e:new Array(r-e.length+1).join(n)+e}function secondsToTime(e){var r="";return 86400<=e&&(r+=Math.floor(e/86400)),3600<=e&&(r+=pad(Math.floor(e/3600)%24,2)+":"),r+=pad(Math.floor(e/60%60),2)+":"+pad(Math.floor(e)%60,2)}function shuttleTime(e,r){switch(e){case"igniting":return"IGN "+secondsToTime(r);case"recalled":return"RCL "+secondsToTime(r);case"called":return"ETA "+secondsToTime(r);case"docked":return"ETD "+secondsToTime(r);case"escape":return"ESC "+secondsToTime(r);case"stranded":return"ERR --:--";case"endgame: game over":return"FIN 00:00"}return""}function popcapstring(e){let r="",n=Number(e.serverdata.popcap);var a=Number(e.hard_popcap),t=Number(e.extreme_popcap);if(n=n||Number(e.popcap),t){if(a&&a<t)return a+"("+t+")";r=t}else{if(a)return a;if(n)return n}return r}function setbannererrormode(e,r){$(".gamebannermode",e.target).toggle(!r),$(".gamebannermap",e.target).toggle(!r),$(".gamebannerttl",e.target).toggle(!r),$(".gamebannererror",e.target).toggle(r),$(e.target).toggleClass("statuserror",r)}function bannererror(e,r){return $(".gamebannererror",e.target).text(r),setbannererrormode(e,!0),0}function infofillbanner(r,n){if(r.gamebannerspan&&($(r.target).replaceWith(r.gamebannerspan),r.target=r.gamebannerspan,r.gamebannerspan=null,$(".gamebannerloader",r.target).toggle(!1),$(".gamebannerbunker",r.target).toggle(!1),$(".gamebannerhub",r.target).toggle(!1),$(".gamebannernoenter",r.target).toggle(!1),r.spinning=!1),!n||"object"!=typeof n)return $(".gamebannername",r.target).text(r.server),bannererror(r,"Invalid Game Banner!");if($(".gamebanneraddr",r.target).text(n.serverdata.address+":"+n.serverdata.port+" "+(n.hasOwnProperty("revision")?n.revision.substr(0,7):"")),$(".gamebannername",r.target).text(n.serverdata.servername),n.hasOwnProperty("errorgrace")&&n.errorgrace?r.spinning=!0:1==r.spinning&&($(".gamebannerloader",r.target).toggle(!1),r.spinning=!1),n.serverdata.hasOwnProperty("eventcolors")?n.serverdata.eventcolors?$(r.target).addClass("statusevent"):$(r.target).removeClass("statusevent"):n.hasOwnProperty("event_colors")&&n.event_colors?$(r.target).addClass("statusevent"):$(r.target).removeClass("statusevent"),n.hasOwnProperty("ERROR")||!n.hasOwnProperty("players")||!n.hasOwnProperty("version")){if(n.restarting&&n.restarting<18)return bannererror(r,"Server Restarting"+".".repeat(n.restarting));let e="Connection Error!";return n.serverdata.errortext&&(e=n.serverdata.errortext),bannererror(r,e)}switch($(".gamebannerbunker",r.target).toggle(!(!n.hasOwnProperty("bunkered")||!n.bunkered)),$(".gamebannerhub",r.target).toggle(!(!n.hasOwnProperty("hub")||!n.hub)),$(".gamebannernoenter",r.target).toggle(!(!n.hasOwnProperty("enter")||n.enter)),setbannererrormode(r,!1),Number(n.gamestate)){case 2:case 3:$(r.target).removeClass("statuslobby statusroundend").addClass("statusinprogress");break;case 4:$(r.target).removeClass("statusinprogress statuslobby").addClass("statusroundend");break;default:$(r.target).removeClass("statusinprogress statusroundend").addClass("statuslobby")}let e="Playing /tg/Station 13";n.hasOwnProperty("version")&&(e="Playing "+n.version),n.hasOwnProperty("custom_event")?e="Playing Event "+n.custom_event:n.hasOwnProperty("mode")&&(e+=' mode "'+n.mode+'"'),$(".gamebannermode",r.target).text(e),n.hasOwnProperty("map_name")?$(".gamebannermap",r.target).text("The map is: "+n.map_name):$(".gamebannermap",r.target).text("Â ");let a="";a+=n.players;var t=popcapstring(n);return t&&(a+="/"+t),Number(n.round_duration)&&(a+=" "+secondsToTime(Number(n.round_duration))),n.hasOwnProperty("shuttle_mode")&&Number(n.shuttle_timer)&&(a+=" "+shuttleTime(n.shuttle_mode,Number(n.shuttle_timer))),$(".gamebannerttl",r.target).text(a),n.players}function reloadbanners(e){let r=refreshtime;e||!getCookie("disablerefresh")?$.get("https://tgstation13.org/dynamicimages/serverinfo.json",function(n){let a=0;n.hasOwnProperty("refreshtime")&&(refreshtime=Math.max(Number(n.refreshtime),750)),$.each(refreshjobs,function(e,r){a+=infofillbanner(r,n[e])}),$(".bannerusercount").text(a+" total players.")}):r*=60,!document.hidden&&iSeeYou||(r*=1.5),DevilsWorkshopLvl&&(!document.hidden&&iSeeYou||(r*=2),r*=Math.min(DevilsWorkshopLvl,5)),clearTimeout(refreshtimer),refreshtimer=setTimeout(function(){reloadbanners()},r)}refreshtimer=0,refreshtime=1e3;var devilInterval=0,DevilsWorkshopLvl=0;document.onmousemove=function(){DevilsWorkshopLvl&&reloadbanners(),clearInterval(devilInterval),DevilsWorkshopLvl=0,devilInterval=setInterval(function(){DevilsWorkshopLvl++},12e4)};var iSeeYou=1;window.onfocus=function(){iSeeYou=1,reloadbanners()},window.onblur=function(){iSeeYou=0},$(function(){$("[data-gamebannerserver]").each(function(e){setupreloader($(this).data("gamebannerserver"),this)}),reloadbanners(!0)});